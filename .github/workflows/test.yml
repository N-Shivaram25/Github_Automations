name: Language-Specific Test Executor

on:
  push:
    paths:
      - 'solutions/**'

jobs:
  detect-language:
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.set.outputs.language }}
      multiple_changed: ${{ steps.set.outputs.multiple_changed }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Detect Changed File and Language
        id: set
        run: |
          echo "Checking for modified solution files..."
          changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^solutions/')
          echo "Changed files:"
          echo "$changed_files"

          file_count=$(echo "$changed_files" | wc -l)

          if [ "$file_count" -gt 1 ]; then
            echo "More than one solution file modified. Failing..."
            echo "multiple_changed=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "multiple_changed=false" >> $GITHUB_OUTPUT

          file=$(echo "$changed_files" | head -n 1)

          if [[ "$file" == *.py ]]; then
            echo "language=python" >> $GITHUB_OUTPUT
          elif [[ "$file" == *.c ]]; then
            echo "language=c" >> $GITHUB_OUTPUT
          elif [[ "$file" == *.cpp ]]; then
            echo "language=cpp" >> $GITHUB_OUTPUT
          elif [[ "$file" == *.java ]]; then
            echo "language=java" >> $GITHUB_OUTPUT
          else
            echo "Unsupported file type: $file"
            exit 1
          fi

  run-tests:
    needs: detect-language
    if: needs.detect-language.outputs.multiple_changed != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Python Test
      - name: Run Python Tests
        if: needs.detect-language.outputs.language == 'python'
        run: |
          echo "Running Python tests..."
          python3 -m pip install --upgrade pip
          python3 tests/test.py

      # C Test
      - name: Run C Tests
        if: needs.detect-language.outputs.language == 'c'
        run: |
          echo "Compiling and running C test..."
          gcc solutions/solution.c tests/test.c -o c_test
          ./c_test

      # C++ Test
      - name: Run C++ Tests
        if: needs.detect-language.outputs.language == 'cpp'
        run: |
          echo "Compiling and running C++ test..."
          g++ solutions/solution.cpp tests/test.cpp -o cpp_test
          ./cpp_test

      # Java Test
      - name: Run Java Tests
        if: needs.detect-language.outputs.language == 'java'
        run: |
          echo "Compiling and running Java test..."
          mkdir -p out
          javac -d out solutions/Solution.java tests/Test.java
          java -cp out Test
